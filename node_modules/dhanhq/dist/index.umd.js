!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("isomorphic-unfetch"),require("ws"),require("buffer")):"function"==typeof define&&define.amd?define(["exports","isomorphic-unfetch","ws","buffer"],t):t((e||self).dhanhq={},e.isomorphicUnfetch,e.ws,e.buffer)}(this,function(e,t,n,r){function i(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}}),t.default=e,t}var o,s,c,a,u,h,d,f,l,v,p,E,O,I=/*#__PURE__*/i(t);function S(){return S=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},S.apply(this,arguments)}function P(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,y(e,t)}function y(e,t){return y=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},y(e,t)}e.DhanEnv=void 0,(o=e.DhanEnv||(e.DhanEnv={})).PROD="PROD",o.SANDBOX="SANDBOX",e.DrvOptionType=void 0,(s=e.DrvOptionType||(e.DrvOptionType={})).CALL="CALL",s.PUT="PUT",e.Exchange=void 0,(c=e.Exchange||(e.Exchange={})).NSE="NSE",c.BSE="BSE",e.ExchangeSegment=void 0,(a=e.ExchangeSegment||(e.ExchangeSegment={})).NSE_EQ="NSE_EQ",a.NSE_FNO="NSE_FNO",a.NSE_CURRENCY="NSE_CURRENCY",a.BSE_EQ="BSE_EQ",a.MCX_COMM="MCX_COMM",a.IDX_I="IDX_I",e.Instrument=void 0,(u=e.Instrument||(e.Instrument={})).EQUITY="EQUITY",u.FUTCOM="FUTCOM",u.FUTCUR="FUTCUR",u.FUTIDX="FUTIDX",u.FUTSTK="FUTSTK",u.INDEX="INDEX",e.ProductType=void 0,(h=e.ProductType||(e.ProductType={})).CNC="CNC",h.INTRADAY="INTRADAY",h.MARGIN="MARGIN",h.CO="CO",h.BO="BO",h.MTF="MTF",e.AmoTime=void 0,(d=e.AmoTime||(e.AmoTime={})).OPEN="OPEN",d.OPEN_30="OPEN_30",d.OPEN_60="OPEN_60",e.LegName=void 0,(f=e.LegName||(e.LegName={})).ENTRY_LEG="ENTRY_LEG",f.TARGET_LEG="TARGET_LEG",f.STOP_LOSS_LEG="STOP_LOSS_LEG",e.OrderStatus=void 0,(l=e.OrderStatus||(e.OrderStatus={})).TRANSIT="TRANSIT",l.PENDING="PENDING",l.REJECTED="REJECTED",l.CANCELLED="CANCELLED",l.TRADED="TRADED",l.EXPIRED="EXPIRED",e.OrderType=void 0,(v=e.OrderType||(e.OrderType={})).LIMIT="LIMIT",v.MARKET="MARKET",v.STOP_LOSS="STOP_LOSS",v.STOP_LOSS_MARKET="STOP_LOSS_MARKET",e.TransactionType=void 0,(p=e.TransactionType||(e.TransactionType={})).BUY="BUY",p.SELL="SELL",e.Validity=void 0,(E=e.Validity||(e.Validity={})).DAY="DAY",E.IOC="IOC",e.PositionType=void 0,(O=e.PositionType||(e.PositionType={})).LONG="LONG",O.SHORT="SHORT",O.CLOSED="CLOSED";var T=function(e,t,n,r,i,o){this.bidOrders=void 0,this.bidQuantity=void 0,this.bidPrice=void 0,this.askPrice=void 0,this.askQuantity=void 0,this.askOrders=void 0,this.bidOrders=e,this.bidQuantity=t,this.bidPrice=n,this.askPrice=r,this.askQuantity=i,this.askOrders=o},k=function(e,t,n,r,i,o,s,c,a,u,h,d,f,l){this.type=void 0,this.responseCode=void 0,this.securityId=void 0,this.ltp=void 0,this.ltq=void 0,this.ltt=void 0,this.atp=void 0,this.volume=void 0,this.totalSellQuantity=void 0,this.totalBuyQuantity=void 0,this.openPrice=void 0,this.closePrice=void 0,this.highPrice=void 0,this.lowPrice=void 0,this.type=e,this.responseCode=t,this.securityId=n,this.ltp=r,this.ltq=i,this.ltt=o,this.atp=s,this.volume=c,this.totalSellQuantity=a,this.totalBuyQuantity=u,this.openPrice=h,this.closePrice=d,this.highPrice=f,this.lowPrice=l},b=function(e,t,n,r,i){this.type=void 0,this.responseCode=void 0,this.exchangeSegment=void 0,this.securityId=void 0,this.openInterest=void 0,this.type=e,this.responseCode=t,this.exchangeSegment=n,this.securityId=r,this.openInterest=i},g=function(e,t,n){this.type=void 0,this.responseCode=void 0,this.status=void 0,this.type=e,this.responseCode=t,this.status=n},m=function(e,t,n,r){this.type=void 0,this.responseCode=void 0,this.ltp=void 0,this.depthLevels=void 0,this.type=e,this.responseCode=t,this.ltp=n,this.depthLevels=r},C=function(e,t,n,r,i,o){this.type=void 0,this.responseCode=void 0,this.exchangeSegment=void 0,this.securityId=void 0,this.prevClosePrice=void 0,this.prevOpenInterest=void 0,this.type=e,this.responseCode=t,this.exchangeSegment=n,this.securityId=r,this.prevClosePrice=i,this.prevOpenInterest=o},D=function(e,t,n,r,i,o){this.type=void 0,this.responseCode=void 0,this.exchangeSegment=void 0,this.securityId=void 0,this.ltp=void 0,this.ltt=void 0,this.type=e,this.responseCode=t,this.exchangeSegment=n,this.securityId=r,this.ltp=i,this.ltt=o},L=I.default||I,R=/*#__PURE__*/function(){function e(e){this.accessToken=void 0,this.baseUrl=void 0,this.accessToken=e.accessToken||"",this.baseUrl="https://api.dhan.co"}return e.prototype.request=function(e,t){var n=""+this.baseUrl+e,r=S({},t,{headers:{"Content-Type":"application/json","access-token":this.accessToken}});return L(n,r).then(function(e){return e.json()})},e}(),N=function(){};N.ORDERS="/orders",N.ORDERS_SLICING="/orders/slicing",N.ORDERS_BY_CORRELATION="/orders/external",N.TRADE_BOOK="/trades",N.HOLDINGS="/holdings",N.POSITIONS="/positions",N.POSITIONS_CONVERT="/positions/convert",N.EDIS="/edis/tpin",N.EDIS_FORM="/edis/form",N.EDIS_INQUIRE_ISIN="/edis/inquire/isin",N.FUND_LIMIT="/fundlimit",N.HISTORICAL="/charts/historical",N.HISTORICAL_INTRADAY="/charts/intraday";var _=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}P(t,e);var n=t.prototype;return n.generateTpin=function(){return this.request("/"+N.EDIS)},n.postEdisTpinForm=function(e){return this.request("/"+N.EDIS_FORM,{method:"POST",body:JSON.stringify(e)})},n.getEdisStatusAndInquiry=function(){return this.request("/"+N.EDIS_INQUIRE_ISIN)},n.getFundLimit=function(){return this.request("/"+N.FUND_LIMIT)},n.getDailyHistoricalData=function(e){return this.request("/"+N.HISTORICAL,{method:"POST",body:JSON.stringify(e)})},n.getIntradayHistoricalData=function(e){return this.request("/"+N.HISTORICAL_INTRADAY,{method:"POST",body:JSON.stringify(e)})},n.placeOrder=function(e){return this.request("/"+N.ORDERS,{method:"POST",body:JSON.stringify(e)})},n.modifyOrder=function(e,t){return this.request("/"+N.ORDERS+"/"+e,{method:"PUT",body:JSON.stringify(t)})},n.cancelOrderByOrderId=function(e){return this.request("/"+N.ORDERS+"/"+e,{method:"DELETE"})},n.placeSliceOrder=function(e){return this.request("/"+N.ORDERS_SLICING,{method:"POST",body:JSON.stringify(e)})},n.getAllOrders=function(){return this.request("/"+N.ORDERS)},n.getOrderByOrderId=function(e){return this.request("/"+N.ORDERS+"/"+e)},n.getOrderByCorrelationId=function(e){return this.request("/"+N.ORDERS_BY_CORRELATION+"/"+e)},n.getTradeBook=function(){return this.request("/"+N.TRADE_BOOK)},n.getTradesOfAnOrderByOrderId=function(e){return this.request("/"+N.TRADE_BOOK+"/"+e)},n.getHoldings=function(){return this.request("/"+N.HOLDINGS)},n.getPositions=function(){return this.request("/"+N.POSITIONS)},n.convertPosition=function(e){return this.request("/"+N.POSITIONS_CONVERT,{method:"POST",body:JSON.stringify(e)})},t}(R);function w(e,t,n){if(!e.s){if(n instanceof U){if(!n.s)return void(n.o=w.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(w.bind(null,e,t),w.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}const U=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){const r=new e,i=this.s;if(i){const e=1&i?t:n;if(e){try{w(r,1,e(this.v))}catch(e){w(r,2,e)}return r}return this}return this.o=function(e){try{const i=e.v;1&e.s?w(r,1,t?t(i):i):n?w(r,1,n(i)):w(r,2,i)}catch(e){w(r,2,e)}},r},e}();function A(e){return e instanceof U&&1&e.s}var B,M=/*#__PURE__*/function(){function e(e){this.sdkInstance=void 0,this.sdkInstance=e}var t=e.prototype;return t.onConnectionEstablished=function(e){try{var t=this,n=function(){if(t.sdkInstance.onConnect)return Promise.resolve(t.sdkInstance.onConnect(t.sdkInstance)).then(function(){})}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.onMessageReceived=function(e){try{var t=this,n=function(){if(t.sdkInstance.onMessage)return Promise.resolve(t.sdkInstance.onMessage(t.sdkInstance,e)).then(function(){})}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.onClose=function(e,t,n){void 0===t&&(t=null),void 0===n&&(n=null);try{return console.log("WebSocket closed with status "+t+": "+n),e.close(),this.sdkInstance.ws=null,Promise.resolve()}catch(e){return Promise.reject(e)}},e}(),F=/*#__PURE__*/function(){function e(e,t,n,r,i,o,s){void 0===i&&(i=null),void 0===o&&(o=null),void 0===s&&(s=null),this.clientId=void 0,this.accessToken=void 0,this.instruments=void 0,this.subscriptionCode=void 0,this.onConnect=void 0,this.onMessage=void 0,this.onClose=void 0,this.ws=void 0,this.sdkHelper=void 0,this.clientId=e,this.accessToken=t,this.instruments=n,this.subscriptionCode=r,this.onConnect=i,this.onMessage=o,this.onClose=s,this.ws=null,this.sdkHelper=new M(this)}var t=e.prototype;return t.connect=function(){try{var e=this;return""===e.accessToken||""===e.clientId?(console.error("Access Token or Client ID is missing"),Promise.resolve()):(e.ws=new n.WebSocket("wss://api-feed.dhan.co",{headers:{Authorization:"Bearer "+e.accessToken}}),e.ws.on("error",function(t){console.error("WebSocket error:",t),setTimeout(function(){console.log("WEBSOCKET_CLOSE: reconnecting..."),e.connect()},5e3)}),e.ws.on("open",function(){try{return Promise.resolve(e.sdkHelper.onConnectionEstablished(e.ws)).then(function(){})}catch(e){return Promise.reject(e)}}),e.ws.on("message",function(t){try{var n,r=t.readUInt8(0);switch(r){case 2:n=e.processTickerPacket(t);break;case 3:n=e.processMarketDepthPacket(t);break;case 4:n=e.processQuotePacket(t);break;case 5:n=e.processOIDataPacket(t);break;case 6:n=e.processPrevClosePacket(t);break;case 7:n=e.processMarketStatusPacket(t);break;case 50:e.processServerDisConnectionPacket(t),process.exit();break;default:console.warn("Unknown response code: "+r),n=null}return Promise.resolve(e.sdkHelper.onMessageReceived(n)).then(function(){})}catch(e){return Promise.reject(e)}}),e.ws.on("close",function(t,n){try{return console.log("WebSocket closed with code "+t+": "+n),Promise.resolve(e.sdkHelper.onClose(e.ws,t,n.toString())).then(function(){})}catch(e){return Promise.reject(e)}}),Promise.resolve())}catch(e){return Promise.reject(e)}},t.close=function(){try{return this.ws&&this.ws.close(),Promise.resolve()}catch(e){return Promise.reject(e)}},t.send=function(e){try{return this.ws&&this.ws.send(e),Promise.resolve()}catch(e){return Promise.reject(e)}},t.createHeader=function(e,t,n){var i=r.Buffer.alloc(83);return i.writeInt16LE(e,0),i.writeInt32LE(t,2),i.write(n,6,"utf-8"),i},t.subscribeSymbols=function(e,t){try{var r=this,i=new Set(r.instruments);t.forEach(function(e){return i.add(e)}),r.instruments=Array.from(i);var o=function(){if(r.ws&&r.ws.readyState===n.WebSocket.OPEN){var i=r.createSubscriptionPacket(t,e,!0);return Promise.resolve(r.send(i)).then(function(){})}}();return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.subscribe=function(e,t){try{var n=this,r=n.instruments,i=Math.ceil(r.length/100),o=0,s=function(e,t,n){for(var r;;){var i=e();if(A(i)&&(i=i.v),!i)return o;if(i.then){r=0;break}var o=n();if(o&&o.then){if(!A(o)){r=1;break}o=o.s}if(t){var s=t();if(s&&s.then&&!A(s)){r=2;break}}}var c=new U,a=w.bind(null,c,2);return(0===r?i.then(h):1===r?o.then(u):s.then(d)).then(void 0,a),c;function u(r){o=r;do{if(t&&(s=t())&&s.then&&!A(s))return void s.then(d).then(void 0,a);if(!(i=e())||A(i)&&!i.v)return void w(c,1,o);if(i.then)return void i.then(h).then(void 0,a);A(o=n())&&(o=o.v)}while(!o||!o.then);o.then(u).then(void 0,a)}function h(e){e?(o=n())&&o.then?o.then(u).then(void 0,a):u(o):w(c,1,o)}function d(){(i=e())?i.then?i.then(h).then(void 0,a):h(i):w(c,1,o)}}(function(){return o<i},function(){return o++},function(){var e=100*o,t=Math.min(100*(o+1),r.length),i=r.slice(e,t);return Promise.resolve(n.subscribeSymbols(n.subscriptionCode,i)).then(function(){})});return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.createSubscriptionPacket=function(e,t,n){var i=e.length,o=this.createHeader(n?this.subscriptionCode:this.subscriptionCode+1,87+21*i,this.clientId),s=r.Buffer.alloc(4);s.writeInt32LE(i,0);var c=r.Buffer.alloc(0);e.forEach(function(e){var t=e[0],n=e[1],i=r.Buffer.alloc(1);i.writeUInt8(t,0);var o=r.Buffer.alloc(20);o.write(n,0,"utf-8"),c=r.Buffer.concat([c,i,o])});var a=r.Buffer.alloc(21*(100-i));return c=r.Buffer.concat([c,a]),r.Buffer.concat([o,s,c])},t.unsubscribe=function(e,t){try{var r=this;r.instruments=r.instruments.filter(function(e){return!t.some(function(t){return t[0]===e[0]&&t[1]===e[1]})});var i=function(){if(r.ws&&r.ws.readyState===n.WebSocket.OPEN){console.log("Unsubscribing from:",t);var i=r.createUnsubscribePacket(e,t);return Promise.resolve(r.send(i)).then(function(){console.log("Remaining subscribed instruments:",r.instruments)})}}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},t.createUnsubscribePacket=function(e,t){var n=t.length,i=this.createHeader(e+1,87+21*n,this.clientId),o=r.Buffer.alloc(4);o.writeInt32LE(n,0);var s=r.Buffer.alloc(0);t.forEach(function(e){var t=e[0],n=e[1],i=r.Buffer.alloc(1);i.writeUInt8(t,0);var o=r.Buffer.alloc(20);o.write(n,0,"utf-8"),s=r.Buffer.concat([s,i,o])});var c=r.Buffer.alloc(21*(100-n));return s=r.Buffer.concat([s,c]),r.Buffer.concat([i,o,s])},t.processTickerPacket=function(e){if(e.length>=16){var t=e.readUInt8(0),n=e.readUInt8(1),r=e.readUInt32LE(4),i=e.readFloatLE(8),o=e.readUInt32LE(12);return new D("Ticker Packet",t,n,r,Number(i.toFixed(2)),new Date(1e3*o).toISOString())}},t.processPrevClosePacket=function(e){if(e.length>=16){var t=e.readUInt8(0),n=e.readUInt8(1),r=e.readUInt32LE(4),i=e.readFloatLE(8),o=e.readUInt32LE(12);return new C("Prev Close Packet",t,n,r,Number(i.toFixed(2)),o)}},t.processMarketStatusPacket=function(e){if(e.length>=1){var t=e.readUInt8(0);return new g("Market Status Packet",t,7===t?"Market Open":"Market Close")}},t.processQuotePacket=function(e){if(e.length>=50)return new k("Quote Packet",e.readUInt8(0),e.readUInt32LE(4),e.readFloatLE(8),e.readUInt16LE(12),new Date(1e3*e.readUInt32LE(14)).toISOString(),e.readFloatLE(18),e.readUInt32LE(22),e.readUInt32LE(26),e.readUInt32LE(30),e.readFloatLE(34),e.readFloatLE(38),e.readFloatLE(42),e.readFloatLE(46))},t.processOIDataPacket=function(e){if(e.length>=12)return new b("OI Data Packet",e.readUInt8(0),e.readUInt8(1),e.readUInt32LE(4),e.readUInt32LE(8))},t.processMarketDepthPacket=function(e){if(!(e.length<13)){for(var t=new m("Market Depth Packet",e.readUInt8(0),e.readFloatLE(8),[]),n=0;n<5;n++){var r=13+20*n;if(20+(r-=1)>e.length)break;var i=new T(e.readInt16LE(r+8),e.readInt32LE(r),e.readFloatLE(r+12),e.readFloatLE(r+16),e.readInt32LE(r+4),e.readInt16LE(r+10));t.depthLevels.push(i)}return e.length<113&&console.warn("Market Depth packet data is shorter than expected. Expected at least 113 bytes, received "+e.length+" bytes."),t}console.warn("Market Depth packet data is too short for header")},t.processServerDisConnectionPacket=function(e){if(e.length>=1){switch(e.readUInt16LE(9)){case 805:console.log("Connection limit exceeded");break;case 806:console.log("Data APIs not subscribed");break;case 807:console.log("Access token is expired");break;case 808:console.log("Authentication Failed - Check Client ID");break;case 809:console.log("Access token is invalid")}this.close()}},e}(),j=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}return P(t,e),t}(R);B=j,[_].forEach(function(e){Object.getOwnPropertyNames(e.prototype).forEach(function(t){Object.defineProperty(B.prototype,t,Object.getOwnPropertyDescriptor(e.prototype,t))})}),e.BSE=4,e.BSE_CURR=7,e.BSE_FNO=8,e.Depth=19,e.DepthLevel=T,e.DhanFeed=F,e.DhanHqClient=j,e.IDX=0,e.MCX=5,e.MarketDepthResponse=m,e.MarketStatusResponse=g,e.NSE=1,e.NSE_CURR=3,e.NSE_FNO=2,e.OiDataResponse=b,e.PrevCloseResponse=C,e.Quote=17,e.QuoteResponse=k,e.Ticker=15,e.TickerResponse=D});
