import*as t from"isomorphic-unfetch";import{WebSocket as e}from"ws";import{Buffer as n}from"buffer";function r(){return r=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},r.apply(this,arguments)}function i(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,s(t,e)}function s(t,e){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},s(t,e)}var o,c,a,u,h,d,l,f,v,p,I,E,O;!function(t){t.PROD="PROD",t.SANDBOX="SANDBOX"}(o||(o={})),function(t){t.CALL="CALL",t.PUT="PUT"}(c||(c={})),function(t){t.NSE="NSE",t.BSE="BSE"}(a||(a={})),function(t){t.NSE_EQ="NSE_EQ",t.NSE_FNO="NSE_FNO",t.NSE_CURRENCY="NSE_CURRENCY",t.BSE_EQ="BSE_EQ",t.MCX_COMM="MCX_COMM",t.IDX_I="IDX_I"}(u||(u={})),function(t){t.EQUITY="EQUITY",t.FUTCOM="FUTCOM",t.FUTCUR="FUTCUR",t.FUTIDX="FUTIDX",t.FUTSTK="FUTSTK",t.INDEX="INDEX"}(h||(h={})),function(t){t.CNC="CNC",t.INTRADAY="INTRADAY",t.MARGIN="MARGIN",t.CO="CO",t.BO="BO",t.MTF="MTF"}(d||(d={})),function(t){t.OPEN="OPEN",t.OPEN_30="OPEN_30",t.OPEN_60="OPEN_60"}(l||(l={})),function(t){t.ENTRY_LEG="ENTRY_LEG",t.TARGET_LEG="TARGET_LEG",t.STOP_LOSS_LEG="STOP_LOSS_LEG"}(f||(f={})),function(t){t.TRANSIT="TRANSIT",t.PENDING="PENDING",t.REJECTED="REJECTED",t.CANCELLED="CANCELLED",t.TRADED="TRADED",t.EXPIRED="EXPIRED"}(v||(v={})),function(t){t.LIMIT="LIMIT",t.MARKET="MARKET",t.STOP_LOSS="STOP_LOSS",t.STOP_LOSS_MARKET="STOP_LOSS_MARKET"}(p||(p={})),function(t){t.BUY="BUY",t.SELL="SELL"}(I||(I={})),function(t){t.DAY="DAY",t.IOC="IOC"}(E||(E={})),function(t){t.LONG="LONG",t.SHORT="SHORT",t.CLOSED="CLOSED"}(O||(O={}));var S=function(t,e,n,r,i,s){this.bidOrders=void 0,this.bidQuantity=void 0,this.bidPrice=void 0,this.askPrice=void 0,this.askQuantity=void 0,this.askOrders=void 0,this.bidOrders=t,this.bidQuantity=e,this.bidPrice=n,this.askPrice=r,this.askQuantity=i,this.askOrders=s},P=function(t,e,n,r,i,s,o,c,a,u,h,d,l,f){this.type=void 0,this.responseCode=void 0,this.securityId=void 0,this.ltp=void 0,this.ltq=void 0,this.ltt=void 0,this.atp=void 0,this.volume=void 0,this.totalSellQuantity=void 0,this.totalBuyQuantity=void 0,this.openPrice=void 0,this.closePrice=void 0,this.highPrice=void 0,this.lowPrice=void 0,this.type=t,this.responseCode=e,this.securityId=n,this.ltp=r,this.ltq=i,this.ltt=s,this.atp=o,this.volume=c,this.totalSellQuantity=a,this.totalBuyQuantity=u,this.openPrice=h,this.closePrice=d,this.highPrice=l,this.lowPrice=f},y=function(t,e,n,r,i){this.type=void 0,this.responseCode=void 0,this.exchangeSegment=void 0,this.securityId=void 0,this.openInterest=void 0,this.type=t,this.responseCode=e,this.exchangeSegment=n,this.securityId=r,this.openInterest=i},k=function(t,e,n){this.type=void 0,this.responseCode=void 0,this.status=void 0,this.type=t,this.responseCode=e,this.status=n},T=function(t,e,n,r){this.type=void 0,this.responseCode=void 0,this.ltp=void 0,this.depthLevels=void 0,this.type=t,this.responseCode=e,this.ltp=n,this.depthLevels=r},b=function(t,e,n,r,i,s){this.type=void 0,this.responseCode=void 0,this.exchangeSegment=void 0,this.securityId=void 0,this.prevClosePrice=void 0,this.prevOpenInterest=void 0,this.type=t,this.responseCode=e,this.exchangeSegment=n,this.securityId=r,this.prevClosePrice=i,this.prevOpenInterest=s},C=function(t,e,n,r,i,s){this.type=void 0,this.responseCode=void 0,this.exchangeSegment=void 0,this.securityId=void 0,this.ltp=void 0,this.ltt=void 0,this.type=t,this.responseCode=e,this.exchangeSegment=n,this.securityId=r,this.ltp=i,this.ltt=s},m=t.default||t,L=/*#__PURE__*/function(){function t(t){this.accessToken=void 0,this.baseUrl=void 0,this.accessToken=t.accessToken||"",this.baseUrl="https://api.dhan.co"}return t.prototype.request=function(t,e){var n=""+this.baseUrl+t,i=r({},e,{headers:{"Content-Type":"application/json","access-token":this.accessToken}});return m(n,i).then(function(t){return t.json()})},t}(),g=function(){};g.ORDERS="/orders",g.ORDERS_SLICING="/orders/slicing",g.ORDERS_BY_CORRELATION="/orders/external",g.TRADE_BOOK="/trades",g.HOLDINGS="/holdings",g.POSITIONS="/positions",g.POSITIONS_CONVERT="/positions/convert",g.EDIS="/edis/tpin",g.EDIS_FORM="/edis/form",g.EDIS_INQUIRE_ISIN="/edis/inquire/isin",g.FUND_LIMIT="/fundlimit",g.HISTORICAL="/charts/historical",g.HISTORICAL_INTRADAY="/charts/intraday";var D=/*#__PURE__*/function(t){function e(){return t.apply(this,arguments)||this}i(e,t);var n=e.prototype;return n.generateTpin=function(){return this.request("/"+g.EDIS)},n.postEdisTpinForm=function(t){return this.request("/"+g.EDIS_FORM,{method:"POST",body:JSON.stringify(t)})},n.getEdisStatusAndInquiry=function(){return this.request("/"+g.EDIS_INQUIRE_ISIN)},n.getFundLimit=function(){return this.request("/"+g.FUND_LIMIT)},n.getDailyHistoricalData=function(t){return this.request("/"+g.HISTORICAL,{method:"POST",body:JSON.stringify(t)})},n.getIntradayHistoricalData=function(t){return this.request("/"+g.HISTORICAL_INTRADAY,{method:"POST",body:JSON.stringify(t)})},n.placeOrder=function(t){return this.request("/"+g.ORDERS,{method:"POST",body:JSON.stringify(t)})},n.modifyOrder=function(t,e){return this.request("/"+g.ORDERS+"/"+t,{method:"PUT",body:JSON.stringify(e)})},n.cancelOrderByOrderId=function(t){return this.request("/"+g.ORDERS+"/"+t,{method:"DELETE"})},n.placeSliceOrder=function(t){return this.request("/"+g.ORDERS_SLICING,{method:"POST",body:JSON.stringify(t)})},n.getAllOrders=function(){return this.request("/"+g.ORDERS)},n.getOrderByOrderId=function(t){return this.request("/"+g.ORDERS+"/"+t)},n.getOrderByCorrelationId=function(t){return this.request("/"+g.ORDERS_BY_CORRELATION+"/"+t)},n.getTradeBook=function(){return this.request("/"+g.TRADE_BOOK)},n.getTradesOfAnOrderByOrderId=function(t){return this.request("/"+g.TRADE_BOOK+"/"+t)},n.getHoldings=function(){return this.request("/"+g.HOLDINGS)},n.getPositions=function(){return this.request("/"+g.POSITIONS)},n.convertPosition=function(t){return this.request("/"+g.POSITIONS_CONVERT,{method:"POST",body:JSON.stringify(t)})},e}(L);function N(t,e,n){if(!t.s){if(n instanceof R){if(!n.s)return void(n.o=N.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(N.bind(null,t,e),N.bind(null,t,2));t.s=e,t.v=n;var r=t.o;r&&r(t)}}const R=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(e,n){const r=new t,i=this.s;if(i){const t=1&i?e:n;if(t){try{N(r,1,t(this.v))}catch(t){N(r,2,t)}return r}return this}return this.o=function(t){try{const i=t.v;1&t.s?N(r,1,e?e(i):i):n?N(r,1,n(i)):N(r,2,i)}catch(t){N(r,2,t)}},r},t}();function w(t){return t instanceof R&&1&t.s}var _,U=0,A=1,M=2,F=3,B=4,j=5,q=7,H=8,Q=15,G=17,Y=19,x=/*#__PURE__*/function(){function t(t){this.sdkInstance=void 0,this.sdkInstance=t}var e=t.prototype;return e.onConnectionEstablished=function(t){try{var e=this,n=function(){if(e.sdkInstance.onConnect)return Promise.resolve(e.sdkInstance.onConnect(e.sdkInstance)).then(function(){})}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},e.onMessageReceived=function(t){try{var e=this,n=function(){if(e.sdkInstance.onMessage)return Promise.resolve(e.sdkInstance.onMessage(e.sdkInstance,t)).then(function(){})}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},e.onClose=function(t,e,n){void 0===e&&(e=null),void 0===n&&(n=null);try{return console.log("WebSocket closed with status "+e+": "+n),t.close(),this.sdkInstance.ws=null,Promise.resolve()}catch(t){return Promise.reject(t)}},t}(),X=/*#__PURE__*/function(){function t(t,e,n,r,i,s,o){void 0===i&&(i=null),void 0===s&&(s=null),void 0===o&&(o=null),this.clientId=void 0,this.accessToken=void 0,this.instruments=void 0,this.subscriptionCode=void 0,this.onConnect=void 0,this.onMessage=void 0,this.onClose=void 0,this.ws=void 0,this.sdkHelper=void 0,this.clientId=t,this.accessToken=e,this.instruments=n,this.subscriptionCode=r,this.onConnect=i,this.onMessage=s,this.onClose=o,this.ws=null,this.sdkHelper=new x(this)}var r=t.prototype;return r.connect=function(){try{var t=this;return""===t.accessToken||""===t.clientId?(console.error("Access Token or Client ID is missing"),Promise.resolve()):(t.ws=new e("wss://api-feed.dhan.co",{headers:{Authorization:"Bearer "+t.accessToken}}),t.ws.on("error",function(e){console.error("WebSocket error:",e),setTimeout(function(){console.log("WEBSOCKET_CLOSE: reconnecting..."),t.connect()},5e3)}),t.ws.on("open",function(){try{return Promise.resolve(t.sdkHelper.onConnectionEstablished(t.ws)).then(function(){})}catch(t){return Promise.reject(t)}}),t.ws.on("message",function(e){try{var n,r=e.readUInt8(0);switch(r){case 2:n=t.processTickerPacket(e);break;case 3:n=t.processMarketDepthPacket(e);break;case 4:n=t.processQuotePacket(e);break;case 5:n=t.processOIDataPacket(e);break;case 6:n=t.processPrevClosePacket(e);break;case 7:n=t.processMarketStatusPacket(e);break;case 50:t.processServerDisConnectionPacket(e),process.exit();break;default:console.warn("Unknown response code: "+r),n=null}return Promise.resolve(t.sdkHelper.onMessageReceived(n)).then(function(){})}catch(t){return Promise.reject(t)}}),t.ws.on("close",function(e,n){try{return console.log("WebSocket closed with code "+e+": "+n),Promise.resolve(t.sdkHelper.onClose(t.ws,e,n.toString())).then(function(){})}catch(t){return Promise.reject(t)}}),Promise.resolve())}catch(t){return Promise.reject(t)}},r.close=function(){try{return this.ws&&this.ws.close(),Promise.resolve()}catch(t){return Promise.reject(t)}},r.send=function(t){try{return this.ws&&this.ws.send(t),Promise.resolve()}catch(t){return Promise.reject(t)}},r.createHeader=function(t,e,r){var i=n.alloc(83);return i.writeInt16LE(t,0),i.writeInt32LE(e,2),i.write(r,6,"utf-8"),i},r.subscribeSymbols=function(t,n){try{var r=this,i=new Set(r.instruments);n.forEach(function(t){return i.add(t)}),r.instruments=Array.from(i);var s=function(){if(r.ws&&r.ws.readyState===e.OPEN){var i=r.createSubscriptionPacket(n,t,!0);return Promise.resolve(r.send(i)).then(function(){})}}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},r.subscribe=function(t,e){try{var n=this,r=n.instruments,i=Math.ceil(r.length/100),s=0,o=function(t,e,n){for(var r;;){var i=t();if(w(i)&&(i=i.v),!i)return s;if(i.then){r=0;break}var s=n();if(s&&s.then){if(!w(s)){r=1;break}s=s.s}if(e){var o=e();if(o&&o.then&&!w(o)){r=2;break}}}var c=new R,a=N.bind(null,c,2);return(0===r?i.then(h):1===r?s.then(u):o.then(d)).then(void 0,a),c;function u(r){s=r;do{if(e&&(o=e())&&o.then&&!w(o))return void o.then(d).then(void 0,a);if(!(i=t())||w(i)&&!i.v)return void N(c,1,s);if(i.then)return void i.then(h).then(void 0,a);w(s=n())&&(s=s.v)}while(!s||!s.then);s.then(u).then(void 0,a)}function h(t){t?(s=n())&&s.then?s.then(u).then(void 0,a):u(s):N(c,1,s)}function d(){(i=t())?i.then?i.then(h).then(void 0,a):h(i):N(c,1,s)}}(function(){return s<i},function(){return s++},function(){var t=100*s,e=Math.min(100*(s+1),r.length),i=r.slice(t,e);return Promise.resolve(n.subscribeSymbols(n.subscriptionCode,i)).then(function(){})});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},r.createSubscriptionPacket=function(t,e,r){var i=t.length,s=this.createHeader(r?this.subscriptionCode:this.subscriptionCode+1,87+21*i,this.clientId),o=n.alloc(4);o.writeInt32LE(i,0);var c=n.alloc(0);t.forEach(function(t){var e=t[0],r=t[1],i=n.alloc(1);i.writeUInt8(e,0);var s=n.alloc(20);s.write(r,0,"utf-8"),c=n.concat([c,i,s])});var a=n.alloc(21*(100-i));return c=n.concat([c,a]),n.concat([s,o,c])},r.unsubscribe=function(t,n){try{var r=this;r.instruments=r.instruments.filter(function(t){return!n.some(function(e){return e[0]===t[0]&&e[1]===t[1]})});var i=function(){if(r.ws&&r.ws.readyState===e.OPEN){console.log("Unsubscribing from:",n);var i=r.createUnsubscribePacket(t,n);return Promise.resolve(r.send(i)).then(function(){console.log("Remaining subscribed instruments:",r.instruments)})}}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},r.createUnsubscribePacket=function(t,e){var r=e.length,i=this.createHeader(t+1,87+21*r,this.clientId),s=n.alloc(4);s.writeInt32LE(r,0);var o=n.alloc(0);e.forEach(function(t){var e=t[0],r=t[1],i=n.alloc(1);i.writeUInt8(e,0);var s=n.alloc(20);s.write(r,0,"utf-8"),o=n.concat([o,i,s])});var c=n.alloc(21*(100-r));return o=n.concat([o,c]),n.concat([i,s,o])},r.processTickerPacket=function(t){if(t.length>=16){var e=t.readUInt8(0),n=t.readUInt8(1),r=t.readUInt32LE(4),i=t.readFloatLE(8),s=t.readUInt32LE(12);return new C("Ticker Packet",e,n,r,Number(i.toFixed(2)),new Date(1e3*s).toISOString())}},r.processPrevClosePacket=function(t){if(t.length>=16){var e=t.readUInt8(0),n=t.readUInt8(1),r=t.readUInt32LE(4),i=t.readFloatLE(8),s=t.readUInt32LE(12);return new b("Prev Close Packet",e,n,r,Number(i.toFixed(2)),s)}},r.processMarketStatusPacket=function(t){if(t.length>=1){var e=t.readUInt8(0);return new k("Market Status Packet",e,7===e?"Market Open":"Market Close")}},r.processQuotePacket=function(t){if(t.length>=50)return new P("Quote Packet",t.readUInt8(0),t.readUInt32LE(4),t.readFloatLE(8),t.readUInt16LE(12),new Date(1e3*t.readUInt32LE(14)).toISOString(),t.readFloatLE(18),t.readUInt32LE(22),t.readUInt32LE(26),t.readUInt32LE(30),t.readFloatLE(34),t.readFloatLE(38),t.readFloatLE(42),t.readFloatLE(46))},r.processOIDataPacket=function(t){if(t.length>=12)return new y("OI Data Packet",t.readUInt8(0),t.readUInt8(1),t.readUInt32LE(4),t.readUInt32LE(8))},r.processMarketDepthPacket=function(t){if(!(t.length<13)){for(var e=new T("Market Depth Packet",t.readUInt8(0),t.readFloatLE(8),[]),n=0;n<5;n++){var r=13+20*n;if(20+(r-=1)>t.length)break;var i=new S(t.readInt16LE(r+8),t.readInt32LE(r),t.readFloatLE(r+12),t.readFloatLE(r+16),t.readInt32LE(r+4),t.readInt16LE(r+10));e.depthLevels.push(i)}return t.length<113&&console.warn("Market Depth packet data is shorter than expected. Expected at least 113 bytes, received "+t.length+" bytes."),e}console.warn("Market Depth packet data is too short for header")},r.processServerDisConnectionPacket=function(t){if(t.length>=1){switch(t.readUInt16LE(9)){case 805:console.log("Connection limit exceeded");break;case 806:console.log("Data APIs not subscribed");break;case 807:console.log("Access token is expired");break;case 808:console.log("Authentication Failed - Check Client ID");break;case 809:console.log("Access token is invalid")}this.close()}},t}(),K=/*#__PURE__*/function(t){function e(){return t.apply(this,arguments)||this}return i(e,t),e}(L);_=K,[D].forEach(function(t){Object.getOwnPropertyNames(t.prototype).forEach(function(e){Object.defineProperty(_.prototype,e,Object.getOwnPropertyDescriptor(t.prototype,e))})});export{l as AmoTime,B as BSE,q as BSE_CURR,H as BSE_FNO,Y as Depth,S as DepthLevel,o as DhanEnv,X as DhanFeed,K as DhanHqClient,c as DrvOptionType,a as Exchange,u as ExchangeSegment,U as IDX,h as Instrument,f as LegName,j as MCX,T as MarketDepthResponse,k as MarketStatusResponse,A as NSE,F as NSE_CURR,M as NSE_FNO,y as OiDataResponse,v as OrderStatus,p as OrderType,O as PositionType,b as PrevCloseResponse,d as ProductType,G as Quote,P as QuoteResponse,Q as Ticker,C as TickerResponse,I as TransactionType,E as Validity};
