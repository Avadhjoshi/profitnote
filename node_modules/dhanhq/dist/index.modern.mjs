import*as t from"isomorphic-unfetch";import{WebSocket as e}from"ws";import{Buffer as s}from"buffer";function i(){return i=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=s[i])}return t},i.apply(this,arguments)}var n,o,r,c,a,h,d,l,u,I,E,O,S;!function(t){t.PROD="PROD",t.SANDBOX="SANDBOX"}(n||(n={})),function(t){t.CALL="CALL",t.PUT="PUT"}(o||(o={})),function(t){t.NSE="NSE",t.BSE="BSE"}(r||(r={})),function(t){t.NSE_EQ="NSE_EQ",t.NSE_FNO="NSE_FNO",t.NSE_CURRENCY="NSE_CURRENCY",t.BSE_EQ="BSE_EQ",t.MCX_COMM="MCX_COMM",t.IDX_I="IDX_I"}(c||(c={})),function(t){t.EQUITY="EQUITY",t.FUTCOM="FUTCOM",t.FUTCUR="FUTCUR",t.FUTIDX="FUTIDX",t.FUTSTK="FUTSTK",t.INDEX="INDEX"}(a||(a={})),function(t){t.CNC="CNC",t.INTRADAY="INTRADAY",t.MARGIN="MARGIN",t.CO="CO",t.BO="BO",t.MTF="MTF"}(h||(h={})),function(t){t.OPEN="OPEN",t.OPEN_30="OPEN_30",t.OPEN_60="OPEN_60"}(d||(d={})),function(t){t.ENTRY_LEG="ENTRY_LEG",t.TARGET_LEG="TARGET_LEG",t.STOP_LOSS_LEG="STOP_LOSS_LEG"}(l||(l={})),function(t){t.TRANSIT="TRANSIT",t.PENDING="PENDING",t.REJECTED="REJECTED",t.CANCELLED="CANCELLED",t.TRADED="TRADED",t.EXPIRED="EXPIRED"}(u||(u={})),function(t){t.LIMIT="LIMIT",t.MARKET="MARKET",t.STOP_LOSS="STOP_LOSS",t.STOP_LOSS_MARKET="STOP_LOSS_MARKET"}(I||(I={})),function(t){t.BUY="BUY",t.SELL="SELL"}(E||(E={})),function(t){t.DAY="DAY",t.IOC="IOC"}(O||(O={})),function(t){t.LONG="LONG",t.SHORT="SHORT",t.CLOSED="CLOSED"}(S||(S={}));class p{constructor(t,e,s,i,n,o){this.bidOrders=void 0,this.bidQuantity=void 0,this.bidPrice=void 0,this.askPrice=void 0,this.askQuantity=void 0,this.askOrders=void 0,this.bidOrders=t,this.bidQuantity=e,this.bidPrice=s,this.askPrice=i,this.askQuantity=n,this.askOrders=o}}class T{constructor(t,e,s,i,n,o,r,c,a,h,d,l,u,I){this.type=void 0,this.responseCode=void 0,this.securityId=void 0,this.ltp=void 0,this.ltq=void 0,this.ltt=void 0,this.atp=void 0,this.volume=void 0,this.totalSellQuantity=void 0,this.totalBuyQuantity=void 0,this.openPrice=void 0,this.closePrice=void 0,this.highPrice=void 0,this.lowPrice=void 0,this.type=t,this.responseCode=e,this.securityId=s,this.ltp=i,this.ltq=n,this.ltt=o,this.atp=r,this.volume=c,this.totalSellQuantity=a,this.totalBuyQuantity=h,this.openPrice=d,this.closePrice=l,this.highPrice=u,this.lowPrice=I}}class k{constructor(t,e,s,i,n){this.type=void 0,this.responseCode=void 0,this.exchangeSegment=void 0,this.securityId=void 0,this.openInterest=void 0,this.type=t,this.responseCode=e,this.exchangeSegment=s,this.securityId=i,this.openInterest=n}}class v{constructor(t,e,s){this.type=void 0,this.responseCode=void 0,this.status=void 0,this.type=t,this.responseCode=e,this.status=s}}class C{constructor(t,e,s,i){this.type=void 0,this.responseCode=void 0,this.ltp=void 0,this.depthLevels=void 0,this.type=t,this.responseCode=e,this.ltp=s,this.depthLevels=i}}class y{constructor(t,e,s,i,n,o){this.type=void 0,this.responseCode=void 0,this.exchangeSegment=void 0,this.securityId=void 0,this.prevClosePrice=void 0,this.prevOpenInterest=void 0,this.type=t,this.responseCode=e,this.exchangeSegment=s,this.securityId=i,this.prevClosePrice=n,this.prevOpenInterest=o}}class P{constructor(t,e,s,i,n,o){this.type=void 0,this.responseCode=void 0,this.exchangeSegment=void 0,this.securityId=void 0,this.ltp=void 0,this.ltt=void 0,this.type=t,this.responseCode=e,this.exchangeSegment=s,this.securityId=i,this.ltp=n,this.ltt=o}}const L=t.default||t;class g{constructor(t){this.accessToken=void 0,this.baseUrl=void 0,this.accessToken=t.accessToken||"",this.baseUrl="https://api.dhan.co"}request(t,e){const s=`${this.baseUrl}${t}`,n=i({},e,{headers:{"Content-Type":"application/json","access-token":this.accessToken}});return L(s,n).then(t=>t.json())}}class D{}D.ORDERS="/orders",D.ORDERS_SLICING="/orders/slicing",D.ORDERS_BY_CORRELATION="/orders/external",D.TRADE_BOOK="/trades",D.HOLDINGS="/holdings",D.POSITIONS="/positions",D.POSITIONS_CONVERT="/positions/convert",D.EDIS="/edis/tpin",D.EDIS_FORM="/edis/form",D.EDIS_INQUIRE_ISIN="/edis/inquire/isin",D.FUND_LIMIT="/fundlimit",D.HISTORICAL="/charts/historical",D.HISTORICAL_INTRADAY="/charts/intraday";const b=0,N=1,R=2,f=3,w=4,U=5,_=7,m=8,A=15,M=17,F=19;class ${constructor(t){this.sdkInstance=void 0,this.sdkInstance=t}async onConnectionEstablished(t){this.sdkInstance.onConnect&&await this.sdkInstance.onConnect(this.sdkInstance)}async onMessageReceived(t){this.sdkInstance.onMessage&&await this.sdkInstance.onMessage(this.sdkInstance,t)}async onClose(t,e=null,s=null){console.log(`WebSocket closed with status ${e}: ${s}`),t.close(),this.sdkInstance.ws=null}}class B{constructor(t,e,s,i,n=null,o=null,r=null){this.clientId=void 0,this.accessToken=void 0,this.instruments=void 0,this.subscriptionCode=void 0,this.onConnect=void 0,this.onMessage=void 0,this.onClose=void 0,this.ws=void 0,this.sdkHelper=void 0,this.clientId=t,this.accessToken=e,this.instruments=s,this.subscriptionCode=i,this.onConnect=n,this.onMessage=o,this.onClose=r,this.ws=null,this.sdkHelper=new $(this)}async connect(){var t=this;""!==this.accessToken&&""!==this.clientId?(this.ws=new e("wss://api-feed.dhan.co",{headers:{Authorization:`Bearer ${this.accessToken}`}}),this.ws.on("error",t=>{console.error("WebSocket error:",t),setTimeout(()=>{console.log("WEBSOCKET_CLOSE: reconnecting..."),this.connect()},5e3)}),this.ws.on("open",async function(){await t.sdkHelper.onConnectionEstablished(t.ws)}),this.ws.on("message",async function(e){let s;const i=e.readUInt8(0);switch(i){case 2:s=t.processTickerPacket(e);break;case 3:s=t.processMarketDepthPacket(e);break;case 4:s=t.processQuotePacket(e);break;case 5:s=t.processOIDataPacket(e);break;case 6:s=t.processPrevClosePacket(e);break;case 7:s=t.processMarketStatusPacket(e);break;case 50:t.processServerDisConnectionPacket(e),process.exit();break;default:console.warn(`Unknown response code: ${i}`),s=null}await t.sdkHelper.onMessageReceived(s)}),this.ws.on("close",async function(e,s){console.log(`WebSocket closed with code ${e}: ${s}`),await t.sdkHelper.onClose(t.ws,e,s.toString())})):console.error("Access Token or Client ID is missing")}async close(){this.ws&&this.ws.close()}async send(t){this.ws&&this.ws.send(t)}createHeader(t,e,i){const n=s.alloc(83);return n.writeInt16LE(t,0),n.writeInt32LE(e,2),n.write(i,6,"utf-8"),n}async subscribeSymbols(t,s){const i=new Set(this.instruments);if(s.forEach(t=>i.add(t)),this.instruments=Array.from(i),this.ws&&this.ws.readyState===e.OPEN){const e=this.createSubscriptionPacket(s,t,!0);await this.send(e)}}async subscribe(t,e){const s=this.instruments,i=Math.ceil(s.length/100);for(let t=0;t<i;t++){const e=100*t,i=Math.min(100*(t+1),s.length),n=s.slice(e,i);await this.subscribeSymbols(this.subscriptionCode,n)}}createSubscriptionPacket(t,e,i){const n=t.length,o=this.createHeader(i?this.subscriptionCode:this.subscriptionCode+1,87+21*n,this.clientId),r=s.alloc(4);r.writeInt32LE(n,0);let c=s.alloc(0);t.forEach(([t,e])=>{const i=s.alloc(1);i.writeUInt8(t,0);const n=s.alloc(20);n.write(e,0,"utf-8"),c=s.concat([c,i,n])});const a=s.alloc(21*(100-n));return c=s.concat([c,a]),s.concat([o,r,c])}async unsubscribe(t,s){if(this.instruments=this.instruments.filter(t=>!s.some(e=>e[0]===t[0]&&e[1]===t[1])),this.ws&&this.ws.readyState===e.OPEN){console.log("Unsubscribing from:",s);const e=this.createUnsubscribePacket(t,s);await this.send(e),console.log("Remaining subscribed instruments:",this.instruments)}}createUnsubscribePacket(t,e){const i=e.length,n=this.createHeader(t+1,87+21*i,this.clientId),o=s.alloc(4);o.writeInt32LE(i,0);let r=s.alloc(0);e.forEach(([t,e])=>{const i=s.alloc(1);i.writeUInt8(t,0);const n=s.alloc(20);n.write(e,0,"utf-8"),r=s.concat([r,i,n])});const c=s.alloc(21*(100-i));return r=s.concat([r,c]),s.concat([n,o,r])}processTickerPacket(t){if(t.length>=16){const e=t.readUInt8(0),s=t.readUInt8(1),i=t.readUInt32LE(4),n=t.readFloatLE(8),o=t.readUInt32LE(12);return new P("Ticker Packet",e,s,i,Number(n.toFixed(2)),new Date(1e3*o).toISOString())}}processPrevClosePacket(t){if(t.length>=16){const e=t.readUInt8(0),s=t.readUInt8(1),i=t.readUInt32LE(4),n=t.readFloatLE(8),o=t.readUInt32LE(12);return new y("Prev Close Packet",e,s,i,Number(n.toFixed(2)),o)}}processMarketStatusPacket(t){if(t.length>=1){const e=t.readUInt8(0);return new v("Market Status Packet",e,7===e?"Market Open":"Market Close")}}processQuotePacket(t){if(t.length>=50)return new T("Quote Packet",t.readUInt8(0),t.readUInt32LE(4),t.readFloatLE(8),t.readUInt16LE(12),new Date(1e3*t.readUInt32LE(14)).toISOString(),t.readFloatLE(18),t.readUInt32LE(22),t.readUInt32LE(26),t.readUInt32LE(30),t.readFloatLE(34),t.readFloatLE(38),t.readFloatLE(42),t.readFloatLE(46))}processOIDataPacket(t){if(t.length>=12)return new k("OI Data Packet",t.readUInt8(0),t.readUInt8(1),t.readUInt32LE(4),t.readUInt32LE(8))}processMarketDepthPacket(t){if(t.length<13)return void console.warn("Market Depth packet data is too short for header");const e=new C("Market Depth Packet",t.readUInt8(0),t.readFloatLE(8),[]);for(let s=0;s<5;s++){let i=13+20*s;if(i-=1,i+20>t.length)break;const n=new p(t.readInt16LE(i+8),t.readInt32LE(i),t.readFloatLE(i+12),t.readFloatLE(i+16),t.readInt32LE(i+4),t.readInt16LE(i+10));e.depthLevels.push(n)}return t.length<113&&console.warn(`Market Depth packet data is shorter than expected. Expected at least 113 bytes, received ${t.length} bytes.`),e}processServerDisConnectionPacket(t){if(t.length>=1){switch(t.readUInt16LE(9)){case 805:console.log("Connection limit exceeded");break;case 806:console.log("Data APIs not subscribed");break;case 807:console.log("Access token is expired");break;case 808:console.log("Authentication Failed - Check Client ID");break;case 809:console.log("Access token is invalid")}this.close()}}}class q extends g{}var H;H=q,[class extends g{generateTpin(){return this.request(`/${D.EDIS}`)}postEdisTpinForm(t){return this.request(`/${D.EDIS_FORM}`,{method:"POST",body:JSON.stringify(t)})}getEdisStatusAndInquiry(){return this.request(`/${D.EDIS_INQUIRE_ISIN}`)}getFundLimit(){return this.request(`/${D.FUND_LIMIT}`)}getDailyHistoricalData(t){return this.request(`/${D.HISTORICAL}`,{method:"POST",body:JSON.stringify(t)})}getIntradayHistoricalData(t){return this.request(`/${D.HISTORICAL_INTRADAY}`,{method:"POST",body:JSON.stringify(t)})}placeOrder(t){return this.request(`/${D.ORDERS}`,{method:"POST",body:JSON.stringify(t)})}modifyOrder(t,e){return this.request(`/${D.ORDERS}/${t}`,{method:"PUT",body:JSON.stringify(e)})}cancelOrderByOrderId(t){return this.request(`/${D.ORDERS}/${t}`,{method:"DELETE"})}placeSliceOrder(t){return this.request(`/${D.ORDERS_SLICING}`,{method:"POST",body:JSON.stringify(t)})}getAllOrders(){return this.request(`/${D.ORDERS}`)}getOrderByOrderId(t){return this.request(`/${D.ORDERS}/${t}`)}getOrderByCorrelationId(t){return this.request(`/${D.ORDERS_BY_CORRELATION}/${t}`)}getTradeBook(){return this.request(`/${D.TRADE_BOOK}`)}getTradesOfAnOrderByOrderId(t){return this.request(`/${D.TRADE_BOOK}/${t}`)}getHoldings(){return this.request(`/${D.HOLDINGS}`)}getPositions(){return this.request(`/${D.POSITIONS}`)}convertPosition(t){return this.request(`/${D.POSITIONS_CONVERT}`,{method:"POST",body:JSON.stringify(t)})}}].forEach(t=>{Object.getOwnPropertyNames(t.prototype).forEach(e=>{Object.defineProperty(H.prototype,e,Object.getOwnPropertyDescriptor(t.prototype,e))})});export{d as AmoTime,w as BSE,_ as BSE_CURR,m as BSE_FNO,F as Depth,p as DepthLevel,n as DhanEnv,B as DhanFeed,q as DhanHqClient,o as DrvOptionType,r as Exchange,c as ExchangeSegment,b as IDX,a as Instrument,l as LegName,U as MCX,C as MarketDepthResponse,v as MarketStatusResponse,N as NSE,f as NSE_CURR,R as NSE_FNO,k as OiDataResponse,u as OrderStatus,I as OrderType,S as PositionType,y as PrevCloseResponse,h as ProductType,M as Quote,T as QuoteResponse,A as Ticker,P as TickerResponse,E as TransactionType,O as Validity};
