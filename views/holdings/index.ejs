<%- include('../include/header') %>
<%- include('../include/sidebar') %>

<div class="p-6">
  <% 
    let totalInvested = 0;
    let totalMarketValue = 0;
    let totalPnL = 0;
    let todayChange =0;
    let currencySymbol = (market_type && marketCategories.find(m => m.id == market_type)?.market_name?.toLowerCase().includes('crypto')) ? '$' : 'â‚¹';
  %>
  <% holdings.forEach(h => {
    const invested = Math.round(h.quantity * h.average_price);
    const marketValue = Math.round(h.quantity * h.last_price);
    const pnl = Math.round(h.pnl);
    totalInvested += invested;
    totalMarketValue += marketValue;
    totalPnL += pnl;
    todayChange += Math.round(h.quantity * h.day_change);
    

  }) %>

  <!-- Total Cards -->
<div class="flex gap-6 mb-8 flex-wrap lg:flex-nowrap">
  <!-- TODAY'S P&L -->
  <div class="flex-1 bg-[#1e293b] p-6 rounded-2xl shadow-xl flex items-center justify-between min-w-[250px]">
    <div>
      <div class="text-base text-gray-400 flex items-center gap-1">ğŸ“† TODAY'S P&L</div>
      <div class="text-2xl font-bold <%= todayChange >= 0 ? 'text-green-400' : 'text-red-400' %>">
        <%= todayChange >= 0 ? 'â–²' : 'â–¼' %> <%= currencySymbol %><%= todayChange.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
      </div>
    </div>
    <div class="text-4xl <%= todayChange >= 0 ? 'text-green-400' : 'text-red-400' %>">
      <%= todayChange >= 0 ? 'ğŸš€' : 'ğŸ“‰' %>
    </div>
  </div>

  <!-- TOTAL P&L -->
  <div class="flex-1 bg-[#1e293b] p-6 rounded-2xl shadow-xl flex items-center justify-between min-w-[250px]">
    <div>
      <div class="text-base text-gray-400 flex items-center gap-1">ğŸ“‰ TOTAL P&L</div>
      <div class="text-2xl font-bold <%= totalPnL >= 0 ? 'text-green-400' : 'text-red-400' %>">
        <%= totalPnL >= 0 ? 'â–²' : 'â–¼' %> <%= currencySymbol %><%= totalPnL.toLocaleString('en-IN') %>
      </div>
    </div>
    <div class="text-4xl <%= totalPnL >= 0 ? 'text-green-400' : 'text-red-400' %>">
      <%= totalPnL >= 0 ? 'ğŸ“ˆ' : 'ğŸ”»' %>
    </div>
  </div>

  <!-- INVESTED AMOUNT -->
  <div class="flex-1 bg-[#1e293b] p-6 rounded-2xl shadow-xl flex items-center justify-between min-w-[250px]">
    <div>
      <div class="text-base text-gray-400 flex items-center gap-1">ğŸ’° INVESTED AMOUNT</div>
      <div class="text-2xl font-bold text-white">
        <%= currencySymbol %><%= totalInvested.toLocaleString('en-IN') %>
      </div>
    </div>
    <div class="text-4xl text-white">ğŸ’¼</div>
  </div>

  <!-- MARKET VALUE -->
  <div class="flex-1 bg-[#1e293b] p-6 rounded-2xl shadow-xl flex items-center justify-between min-w-[250px]">
    <div>
      <div class="text-base text-gray-400 flex items-center gap-1">ğŸ“Š MARKET VALUE</div>
      <div class="text-2xl font-bold text-white">
        <%= currencySymbol %><%= totalMarketValue.toLocaleString('en-IN') %>
      </div>
    </div>
    <div class="text-4xl text-white">ğŸ¦</div>
  </div>
</div>

  <!-- Filters + Actions -->
  <form method="GET" class="flex items-center gap-2 mb-6 flex-wrap">
    <!-- Broker Filter -->
    <select name="broker" onchange="this.form.submit()" class="bg-[#1e293b] text-white px-3 py-2 rounded-md border border-gray-600 text-sm">
      <option value="">All Brokers</option>
      <% brokerList.forEach(b => { %>
        <option value="<%= b.id %>" <%= broker == b.id ? 'selected' : '' %>><%= b.name %></option>
      <% }) %>
    </select>

    <!-- Market Type Filter -->
    <select name="market_type" onchange="this.form.submit()" class="bg-[#1e293b] text-white px-3 py-2 rounded-md border border-gray-600 text-sm">
       <% marketCategories.forEach(cat => { %>
        <option value="<%= cat.id %>" <%= market_type == cat.id ? 'selected' : '' %>><%= cat.market_name %></option>
      <% }) %>
    </select>

    <!-- Sync Button -->
    <button id="syncHoldingsBtn" onclick="syncHoldings()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-md transition-all">
  ğŸ”„ Sync Holdings
</button>

<!-- AI Insight Button -->
<button id="generateInsightBtn" onclick="generateInsight()" class="bg-purple-600 hover:bg-purple-700 text-white text-sm px-4 py-2 rounded-md transition-all">
  ğŸ” Generate AI Insight
</button>

    <!-- Export Button -->
    <button type="button" id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white text-sm px-4 py-2 rounded-md transition-all">
      ğŸ“„ Export to Excel
    </button>
  </form>
<!-- AI Report Display -->
<div id="aiReportContainer" class="mt-10 hidden bg-[#1e293b] border border-gray-600 rounded-xl p-6 mb-8">
  <div class="flex justify-between items-center mb-3 text-sm text-gray-400">
    <span id="generatedAt">ğŸ“… Generated just now</span>
    <button onclick="downloadAIReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
      ğŸ“„ Download PDF
    </button>
  </div>
  <div id="aiReportContent" class="prose prose-invert prose-sm max-w-none whitespace-pre-wrap text-white"></div>
</div>

  <!-- Holdings Table -->
  <% if (holdings.length === 0) { %>
    <div class="text-gray-400">No holdings found.</div>
  <% } else { %>
    <div class="overflow-x-auto">
      <table id="holdingsTable" class="min-w-full text-sm text-white bg-[#1e293b] rounded-xl overflow-hidden">
       <thead>
          <tr class="bg-[#334155] text-left text-xs uppercase text-gray-300">
             <th class="px-4 py-2 cursor-pointer" onclick="sortTable(1)">Broker <span>â–²â–¼</span></th>
             <th class="px-4 py-2 cursor-pointer" onclick="sortTable(0)">Symbol <span>â–²â–¼</span></th>
            <th class="px-4 py-2 cursor-pointer" onclick="sortTable(2)">Qty <span>â–²â–¼</span></th>
            <th class="px-4 py-2 cursor-pointer" onclick="sortTable(3)">T1 Qty <span>â–²â–¼</span></th>
            <th class="px-4 py-2 cursor-pointer" onclick="sortTable(4)">Avg Price <span>â–²â–¼</span></th>
            <th class="px-4 py-2 cursor-pointer" onclick="sortTable(5)">Last Price <span>â–²â–¼</span></th>
            <th class="px-4 py-2 cursor-pointer" onclick="sortTable(6)">P&L <span>â–²â–¼</span></th>
            <th class="px-4 py-2 cursor-pointer" onclick="sortTable(7)">Invested Amount <span>â–²â–¼</span></th>
            <th class="px-4 py-2 cursor-pointer" onclick="sortTable(8)">Market Value <span>â–²â–¼</span></th>
          </tr>
        </thead>

        <tbody>
          <% holdings.forEach(h => {
            const invested = Math.round(h.quantity * h.average_price);
            const marketValue = Math.round(h.quantity * h.last_price);
            const pnl = Math.round(h.pnl);
          %>
            <tr class="border-b border-gray-700 hover:bg-[#2d3748]">
              <td class="px-4 py-2"><%= h.Broker?.name || '-' %></td>
              <td class="px-4 py-2"><%= h.tradingsymbol %></td>
              <td class="px-4 py-2"><%= h.quantity %></td>
              <td class="px-4 py-2"><%= h.t1_quantity %></td>
              <td class="px-4 py-2"><%= currencySymbol %><%= Math.round(h.average_price).toLocaleString('en-IN') %></td>
              <td class="px-4 py-2"><%= currencySymbol %><%= Math.round(h.last_price).toLocaleString('en-IN') %></td>
              <td class="px-4 py-2 <%= pnl >= 0 ? 'text-green-400' : 'text-red-400' %>">
                <%= pnl >= 0 ? 'â–²' : 'â–¼' %> <%= currencySymbol %><%= pnl.toLocaleString('en-IN') %>
              </td>
              <td class="px-4 py-2"><%= currencySymbol %><%= invested.toLocaleString('en-IN') %></td>
              <td class="px-4 py-2"><%= currencySymbol %><%= marketValue.toLocaleString('en-IN') %></td>
            </tr>
          <% }) %>
        </tbody>
        <tfoot class="bg-[#334155] font-semibold text-white">
          <tr>
            <td class="px-4 py-2" colspan="2">Total</td>
            <td class="px-4 py-2"><%= holdings.reduce((sum, h) => sum + h.quantity, 0) %></td>
            <td class="px-4 py-2"><%= holdings.reduce((sum, h) => sum + h.t1_quantity, 0) %></td>
            <td colspan="2"></td>
            <td class="px-4 py-2 <%= totalPnL >= 0 ? 'text-green-400' : 'text-red-400' %>">
              <%= totalPnL >= 0 ? 'â–²' : 'â–¼' %> <%= currencySymbol %><%= totalPnL.toLocaleString('en-IN') %>
            </td>
            <td class="px-4 py-2"><%= currencySymbol %><%= totalInvested.toLocaleString('en-IN') %></td>
            <td class="px-4 py-2"><%= currencySymbol %><%= totalMarketValue.toLocaleString('en-IN') %></td>
          </tr>
        </tfoot>
      </table>
    </div>
  <% } %>
</div>

<!-- SheetJS (Excel Export) -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
  document.getElementById('exportBtn').addEventListener('click', function () {
    const table = document.getElementById('holdingsTable');
    const wb = XLSX.utils.table_to_book(table, { sheet: "Holdings" });
    XLSX.writeFile(wb, 'holdings_export.xlsx');
  });

  document.querySelectorAll('#holdingsTable th').forEach(header => {
    header.addEventListener('click', () => {
      const table = header.closest('table');
      const index = [...header.parentNode.children].indexOf(header);
      const rows = [...table.querySelectorAll('tbody tr')];
      const asc = !header.classList.contains('asc');

      rows.sort((a, b) => {
        const aText = a.children[index].innerText.replace(/[^\d.-]/g, '');
        const bText = b.children[index].innerText.replace(/[^\d.-]/g, '');
        return asc ? aText - bText : bText - aText;
      });

      table.querySelectorAll('th').forEach(th => th.classList.remove('asc', 'desc'));
      header.classList.add(asc ? 'asc' : 'desc');
      const tbody = table.querySelector('tbody');
      rows.forEach(row => tbody.appendChild(row));
    });
  });
/*  function syncHoldings() {
    const btn = document.getElementById("syncHoldingsBtn");
    btn.disabled = true;
    btn.innerHTML = "Syncing...";

    fetch("/credentials/sync-zerodha-holdings")
      .then(res => res.text())
      .then(msg => {
        Toastify({
          text: msg,
          duration: 4000,
          gravity: "top",
          position: "right",
          backgroundColor: msg.includes("âœ…") ? "#22c55e" : "#ef4444",
        }).showToast();
        btn.disabled = false;
        btn.innerHTML = "ğŸ”„ Sync Holdings";
      })
      .catch(err => {
        Toastify({
          text: "âŒ Error syncing holdings",
          duration: 4000,
          gravity: "top",
          position: "right",
          backgroundColor: "#ef4444",
        }).showToast();
        btn.disabled = false;
        btn.innerHTML = "ğŸ”„ Sync Holdings";
      });
  }*/
  function syncHoldings() {
  const btn = document.getElementById("syncHoldingsBtn");
  btn.disabled = true;
  btn.innerHTML = "Syncing...";

  fetch("/credentials/sync-zerodha-holdings")
    .then(res => res.text())
    .then(msg => {
      Toastify({
        text: msg,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: msg.includes("âœ…") ? "#22c55e" : "#ef4444",
      }).showToast();

      btn.disabled = false;
      btn.innerHTML = "ğŸ”„ Sync Holdings";

      // âœ… Auto-reload after a short delay (optional)
      if (msg.includes("âœ…")) {
        setTimeout(() => {
          location.reload();
        }, 1500); // Reload after 1.5 seconds
      }

    })
    .catch(err => {
      Toastify({
        text: "âŒ Error syncing holdings",
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: "#ef4444",
      }).showToast();

      btn.disabled = false;
      btn.innerHTML = "ğŸ”„ Sync Holdings";
    });
}

</script>
<!-- html2pdf for AI Report -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
  function generateInsight() {
    const btn = document.getElementById('generateInsightBtn');
    btn.disabled = true;
    btn.innerText = 'â³ Generating...';

    fetch('/ai/analyze-holdings')
      .then(res => res.json())
      .then(data => {
        if (data.analysis) {
          const container = document.getElementById('aiReportContainer');
          const content = document.getElementById('aiReportContent');
          const date = document.getElementById('generatedAt');

          content.innerHTML = marked.parse(data.analysis);
          date.innerText = `ğŸ“… Generated: ${new Date().toLocaleString()}`;
          container.classList.remove('hidden');

          Toastify({
            text: "âœ… AI Insight Generated",
            duration: 4000,
            gravity: "top",
            position: "right",
            backgroundColor: "#22c55e"
          }).showToast();
        } else {
         Toastify({
          text: data.error,
          duration: 4000,
          gravity: "top",
          position: "right",
          backgroundColor: "orange" // amber for warning-style
        }).showToast();
        }
      })
      .catch(err => {
        console.error(err);
        Toastify({
          text: "âŒ Failed to generate AI insight",
          duration: 4000,
          gravity: "top",
          position: "right",
          backgroundColor: "#ef4444"
        }).showToast();
      })
      .finally(() => {
        btn.disabled = false;
        btn.innerText = 'ğŸ” Generate AI Insight';
      });
  }

  function downloadAIReport() {
    const element = document.getElementById('aiReportContainer');
    html2pdf().from(element).set({
      margin: 0.5,
      filename: 'AI-Holding-Insight.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    }).save();
  }
</script>

<%- include('../include/footer') %>